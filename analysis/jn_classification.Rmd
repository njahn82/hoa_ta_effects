---
title: "journal classification"
output: html_document
date: "2023-09-15"
---

```{r}
library(tidyverse)
library(hoaddata)
```

issn madness

```{r}
my_jns <- hoaddata::jct_hybrid_jns |>
 # filter(issn_l == "0002-8762") |> 
  mutate(id = issn_l) |>
  pivot_longer(cols = c(issn_l, issn)) |>
  distinct(esac_publisher, esac_id, issn_l = id, issn = value) |>
  inner_join(hoaddata::jn_ind, by = "issn_l")

my_jns_with_oa <- my_jns |>
  filter(!is.na(cc))
```

- Journals in JCT with publication activity (`jct`): `r length(unique(my_jns$issn_l))`.
- Journals in JCT with publication activity and at least one OA article in the sample (`jct_oa`): `r length(unique(my_jns_with_oa$issn_l))`


```{r}
scopus <- readxl::read_excel("~/Downloads/extlistAugust2023.xlsx", sheet = 1,
                                .name_repair = janitor::make_clean_names, col_types = "text")
```

normalize scopus jn indicators

```{r}
scopus_norm <- scopus |>
  select(1:4, all_science_journal_classification_codes_asjc) |>
  separate(print_issn, c("print_issn", "print_issn_extra")) |>
  gather(print_issn, e_issn, print_issn_extra, key = "issn_tpye", value = "issn") |> 
  filter(!is.na(issn)) |>
  # trailing zero's missing in Excel spreadsheet
  mutate(
    issn = ifelse(nchar(issn) == 5, paste0("000", issn), issn),
    issn = ifelse(nchar(issn) == 6, paste0("00", issn), issn),
    issn = ifelse(nchar(issn) == 7, paste0("0", issn), issn)) |>
  # missing hyphen
  mutate(issn = map_chr(issn, function(x) paste(c(substr(x, 1, 4), substr(x, 5, 8)), collapse = "-")))
```


Matching with hybrid journals

```{r}
matched_jns <- my_jns |>
  inner_join(scopus_norm, by = "issn") 

non_matched <- my_jns |>
  filter(!issn %in% scopus_norm$issn) |>
  distinct(issn_l) |>
  filter(!issn_l %in% matched_jns$issn_l)

matched_oa_jns <- my_jns_with_oa |>
  inner_join(scopus_norm, by = "issn") 
```

- Journals (`jct`) in Scopus: `r length(unique(matched_jns$issn_l))`
- Journals with at least one OA (`jct_oa`) in Scopus: `r length(unique(matched_oa_jns$issn_l))`)

```{r final datatset}
# From https://doi.org/10.1002/asi.24549
ajsc_mapped <- readr::read_csv("https://raw.githubusercontent.com/njahn82/elsevier_hybrid_invoicing/master/data/asjc_mapped.csv", col_types = "ccc") 
subject_jn_df <- matched_jns |>
  select(-issn, -esac_id, -source_title_medline_sourced_journals_are_indicated_in_green, -issn_tpye) |>
  distinct() |>
  mutate(ajcs = strsplit(all_science_journal_classification_codes_asjc, ";")) |>
  unnest(ajcs) |>
  mutate(top_level_code = str_extract(ajcs, "\\d{2}"),
         code =  str_extract(ajcs, "\\d{4}")) |>
  inner_join(ajsc_mapped, by = "top_level_code") |>
  rename(top_level = subject_area, subject_area = description) |> 
  select(-all_science_journal_classification_codes_asjc, -ajcs) |>
  distinct()
# back up
write_csv(subject_jn_df, here::here("data", "jn_scopus_ind_subjects.csv"))
```

### Exploration

#### Journals

##### Subject Area

Number of Journals (full and fractional counting)

```{r}
subject_jn_df |> 
  group_by(issn_l, subject_area) |>
  summarise(n = n()) |>
  mutate(fractions = n / sum(n)) |> 
  ungroup() |> 
  group_by(subject_area) |>
  summarise(journals_n = n_distinct(issn_l),
            journals_frac = sum(fractions)) |>
  arrange(desc(journals_frac))
```

##### Top Level

```{r}
subject_jn_df |> 
  group_by(issn_l, top_level) |>
  summarise(n = n()) |>
  mutate(fractions = n / sum(n)) |> 
  ungroup() |> 
  group_by(top_level) |>
  summarise(journals_n = n_distinct(issn_l),
            journals_frac = sum(fractions)) |>
  arrange(desc(journals_frac))
```


#### Article Analysis

##### Top Level

- Article Volume

```{r}
subject_jn_df |>
  distinct(issn_l, jn_all, top_level) |>
  group_by(issn_l, top_level) |>
  summarise(n = sum(jn_all)) |>
  mutate(fractions_factor = n / sum(n)) |>
  mutate(fractions = n * fractions_factor) |>
  ungroup() |> 
  group_by(top_level) |>
  summarise(articles_n = sum(n),
            articles_frac = sum(fractions)) |>
  arrange(desc(articles_frac)) |>
  arrange(desc(articles_n))
```


- OA by year

```{r}
top_level_by_year_jn_oa <- subject_jn_df |>
  # With at least one cc article
  filter(!is.na(cc)) |>
  distinct(cr_year, issn_l, jn_all, top_level) |>
  group_by(cr_year, issn_l, top_level) |>
  summarise(n = sum(jn_all)) |>
  mutate(fractions_factor = n / sum(n)) |>
  mutate(fractions = n * fractions_factor) |>
  ungroup() |> 
  group_by(cr_year, top_level) |>
  summarise(articles_n = sum(n),
            articles_frac = sum(fractions)) |>
  arrange(top_level, cr_year)

top_level_by_year_oa <- subject_jn_df |>
  # With at least one cc article
  filter(!is.na(cc)) |>
  distinct(cr_year, issn_l, cc_total, top_level) |>
  group_by(cr_year, issn_l, top_level) |>
  summarise(n = sum(cc_total)) |>
  mutate(fractions_factor = n / sum(n)) |>
  mutate(fractions = n * fractions_factor) |>
  ungroup() |> 
  group_by(cr_year, top_level) |>
  summarise(oa_n = sum(n),
            oa_frac = sum(fractions)) |>
  arrange(top_level, cr_year)
```

- Join

```{r}
top_level_oa_df <- inner_join(top_level_by_year_jn_oa, top_level_by_year_oa) |>
  mutate(oa_prop = oa_n / articles_n,
         oa_frac_prop = oa_frac / articles_frac)

top_level_oa_df
```

##### Subject Area

```{r}
subject_jn_df |>
  distinct(issn_l, jn_all, subject_area) |>
  group_by(issn_l, subject_area) |>
  summarise(n = sum(jn_all)) |>
  mutate(fractions_factor = n / sum(n)) |>
  mutate(fractions = n * fractions_factor) |>
  ungroup() |> 
  group_by(subject_area) |>
  summarise(articles_n = sum(n),
            articles_frac = sum(fractions)) |>
  arrange(desc(articles_frac)) |>
  arrange(desc(articles_n))
```


- OA by year

```{r}
subject_area_by_year_jn_oa <- subject_jn_df |>
  # With at least one cc article
  filter(!is.na(cc)) |>
  distinct(cr_year, issn_l, jn_all, subject_area) |>
  group_by(cr_year, issn_l, subject_area) |>
  summarise(n = sum(jn_all)) |>
  mutate(fractions_factor = n / sum(n)) |>
  mutate(fractions = n * fractions_factor) |>
  ungroup() |> 
  group_by(cr_year, subject_area) |>
  summarise(articles_n = sum(n),
            articles_frac = sum(fractions)) |>
  arrange(subject_area, cr_year)

subject_area_by_year_oa <- subject_jn_df |>
  # With at least one cc article
  filter(!is.na(cc)) |>
  distinct(cr_year, issn_l, cc_total, subject_area) |>
  group_by(cr_year, issn_l, subject_area) |>
  summarise(n = sum(cc_total)) |>
  mutate(fractions_factor = n / sum(n)) |>
  mutate(fractions = n * fractions_factor) |>
  ungroup() |> 
  group_by(cr_year, subject_area) |>
  summarise(oa_n = sum(n),
            oa_frac = sum(fractions)) |>
  arrange(subject_area, cr_year)
```

- Join

```{r}
subject_area_oa_df <- inner_join(subject_area_by_year_jn_oa, subject_area_by_year_oa) |>
  mutate(oa_prop = oa_n / articles_n,
         oa_frac_prop = oa_frac / articles_frac)
```

- plot

```{r}
subject_area_oa_df |>
  filter(cr_year %in% c("2020", "2021", "2022")) |>
  group_by(subject_area) |>
  summarise(n = sum(articles_n),
            oa = sum(oa_n)) |>
  mutate(closed = n - oa) |>
  pivot_longer(cols = c(oa, closed)) |>
  arrange(desc(n)) |>
  ggplot(aes(reorder(subject_area, n), value, fill = name)) +
  geom_bar(stat = "identity") +
  coord_flip()
```

##### With TA info

```{r}
ta_oa_inst <- readr::read_csv(here::here("data/ta_oa_inst.csv.gz"))

jn_ind_jct <- hoaddata::jct_hybrid_jns |>
  inner_join(hoaddata::jn_ind, by = "issn_l") |>
  filter(issn_l != "0027-8424")

ta_active <- ta_oa_inst |>
  filter(issn_l != "0027-8424") |>
  filter(ta_active == TRUE, !is.na(cc)) |>
  group_by(cr_year, issn_l) |>
  summarise(ta_oa = n_distinct(doi)) |>
  mutate(cr_year = as.character(cr_year))

subject_per_year_df <- subject_jn_df |>
  distinct(issn_l, top_level) |>
  inner_join(ta_active, by = "issn_l") |>
  group_by(cr_year, top_level) |>
  summarise(ta_oa = sum(ta_oa)) |>
  # join with top level oa stats
  right_join(top_level_oa_df) |> 
  mutate(no_ta = oa_n - ta_oa) |>
  pivot_longer(
    cols = c(ta_oa, no_ta),
    names_to = "type",
    values_to = "value"
  ) |>
  # deal with periods where no ta related pub was found 
  mutate(value = ifelse(is.na(value) & type == "ta_oa", 0, value)) |>
  mutate(value = ifelse(is.na(value) & type == "no_ta", oa_n, value)) |>
  mutate(prop = value / articles_n) 
```


```{r}
plot_trend_top_level_ta <- subject_per_year_df |>
  filter(top_level != "Multidisciplinary", cr_year != "2023") |>
  ggplot(aes(gsub("^20", "'", as.character(cr_year)), prop, fill = type, group = type)) +
  geom_area() +
  facet_wrap( ~ top_level, nrow = 1) +
  scale_fill_manual(
    "Hybrid OA",
    values = c(no_ta = "#b3b3b3a0", ta_oa = "#56B4E9"),
    labels = c(no_ta = "Other", ta_oa = "Agreement"),
    guide = guide_legend(reverse = TRUE)
  ) +
  scale_y_continuous(
    expand = expansion(mult = c(0, 0.05)),
    labels = scales::percent_format()
  ) +
  theme_minimal() +
  labs(y = "Hybrid OA Uptake", x = NULL) +
  theme(legend.position = "top", legend.justification = "left")
```

```{r}
# Share of TA
plot_trend_top_level_ta_share <- subject_per_year_df |>
  filter(top_level != "Multidisciplinary", cr_year != "2023") |>
  filter(type == "ta_oa") |>
  ggplot(aes(gsub("^20", "'", as.character(cr_year)), value / oa_n, group = 1)) +
  geom_bar(stat = "identity", fill = "#56B4E9") +
  facet_wrap( ~ top_level, nrow = 1) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)),
                     labels = scales::percent) +
  theme_minimal() +
  labs(y = "Percentage\nof Hybrid OA\nvia Agreement", x = NULL)
```

```{r}
## TA boxplot
plot_trend_top_level_ta_boxplot <- subject_ta_df |>
  pivot_longer(cols = c(ta_oa, no_ta), names_to = "type", values_to = "value") |>
  filter(cr_year != "2023", oa > 0, value > 0, top_level != "Multidisciplinary") |>
  ggplot(aes(gsub("^20", "'", as.character(cr_year)), value / jn_all, fill = type)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)),
                     labels = scales::percent) +
  scale_fill_manual("Hybrid OA", values = c(no_ta = "#b3b3b3a0", ta_oa = "#56B4E9"), labels = c(no_ta = "Other", ta_oa = "Agreement")) +
  coord_cartesian(ylim = c(0,0.55)) +
  facet_wrap(~top_level, nrow = 1) +
  labs(y = "OA Uptake\nby Hybrid Journal", x = "Publication Year") +
  theme_minimal() +
    theme(strip.background = element_blank()
    ) 
```

```{r, fig.asp=1.1}
library(patchwork)
design = "A
B
C"
wrap_plots(
  A = plot_trend_top_level_ta,
  B = plot_trend_top_level_ta_share,
  C = plot_trend_top_level_ta_boxplot,
  design = design,
#  guides = "collect",
 # widths = c(2, 1),
  heights = c(1, 0.5, 1)
) &
  theme(
    legend.position = "top",
    legend.justification = "left",
    legend.direction = "horizontal",
    panel.grid.minor = element_blank(),
                panel.border = element_rect(color = "grey50", fill = NA),
    axis.title=element_text(size = 10)) &
    plot_annotation(tag_levels = 'A') 
```


TA analysis

```{r}
subject_ta_df |>
  pivot_longer(cols = c(ta_oa, no_ta), names_to = "type", values_to = "value") |>
  filter(cr_year != "2023", oa > 0, top_level != "Multidisciplinary") |>
   ggplot(aes(gsub("^20", "'", as.character(cr_year)), value / jn_all, fill = type)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  coord_flip() +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)),
                     labels = scales::percent) +
  scale_fill_manual("Hybrid OA", values = c(no_ta = "#b3b3b3a0", ta_oa = "#56B4E9"), labels = c(no_ta = "Other", ta_oa = "Agreement")) +
  coord_cartesian(ylim = c(0,0.55)) +
  facet_wrap(~subject_area) +
  labs(y = "OA Uptake\nby Hybrid Journal", x = "Publication Year") +
  theme_minimal() +
  theme(strip.background = element_blank())
```


```{r side_by_side_subject_publisher}
# normalize publishers
subject_short <- subject_df  |>  mutate(
    publisher = case_when(
      esac_publisher == "Elsevier" ~ "Elsevier",
      esac_publisher == "Springer Nature" ~ "Springer Nature",
      esac_publisher == "Wiley" ~ "Wiley",
      is.character(esac_publisher) ~ "Other"
    )
  ) |>
  mutate(publisher =
           forcats::fct_relevel(
             publisher,
             c("Elsevier", "Springer Nature", "Wiley", "Other") 
           )) |>
  filter(!cr_year %in%  c("2017", "2023")) |>
  # Journal transfers across publishers grouped in publisher
  select(-esac_publisher) |>
# top level
 select(-subject_area, -ajcs) |>
  distinct() |>
  group_by(cr_year, top_level, publisher, issn_l) |>
  summarise(oa = sum(oa), ta_oa = sum(ta_oa), no_ta = sum(no_ta), jn_all = sum(jn_all))

subject_short |>
  filter(top_level != "Multidisciplinary") |>
  ggplot(aes(cr_year, oa / jn_all)) +
  geom_boxplot(varwidth = TRUE) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)), breaks = c(0, 0.25,0.5,0.75), limits = c(0, .75),
                     labels = scales::percent) +
  facet_grid(top_level ~publisher)



subject_short |>
  ungroup() |>
  filter(oa > 0) |>
  select(-oa) |>
  filter(top_level != "Multidisciplinary") |>
  pivot_longer(cols = c(ta_oa, no_ta), names_to = "oa_type", values_to = "oa") |> 
  ggplot(aes(cr_year, oa / jn_all, fill = oa_type)) +
  geom_boxplot(varwidth = TRUE, outlier.shape = NA, notch = TRUE) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)),
                     labels = scales::percent,
                     limits = c(0, .5)) +
  facet_grid(top_level ~ publisher)

subject_short |>
  ungroup() |>
  filter(oa > 0) |>
  select(-oa) |>
  pivot_longer(cols = c(ta_oa, no_ta), names_to = "oa_type", values_to = "oa") |> 
  filter(top_level != "Multidisciplinary") |>
  mutate(publisher = as.character(publisher)) |>
  group_by(publisher, top_level, cr_year) |>
  
subject_short |>
  ungroup() |>
  filter(oa > 0) |>
  select(-oa) |>
  pivot_longer(cols = c(ta_oa, no_ta), names_to = "oa_type", values_to = "oa") |> 
  filter(top_level != "Multidisciplinary") |>
  mutate(publisher = as.character(publisher)) |>
  group_by(publisher, top_level, cr_year) |>
  summarise(nn = wilcox.test(oa ~ oa-type)$p.value))


subject_short |>
 ungroup() |>
filter(oa > 0) |>
select(-oa) |>
 pivot_longer(cols = c(ta_oa, no_ta), names_to = "oa_type", values_to = "oa") |> 
  mutate(oa_prop = oa / jn_all) |>
 filter(top_level != "Multidisciplinary") |>
 mutate(publisher = as.character(publisher)) |>
  group_by(publisher, top_level, cr_year) |>
  summarise(p_value = wilcox.test(oa ~ oa_type, paired = TRUE)$p.value) |> View()

preprints %>%
  filter(posted_date >= analysis_start,
         posted_date <= analysis_end) %>%
  with(., wilcox.test(n_versions ~ covid_preprint))

```